---
title: "DESeq2 Analyse"
author: "zach"
date: "2025-12-10"
output: html_document
---
```{r}
library(shiny)
library(DESeq2)
library(tidyverse)
library(ggplot2)
library(fdrtool)
library(DT)

ui <- fluidPage(

    titlePanel("RNA-seq DESeq2 Explorer — With Pathway Gene Highlighting"),

    sidebarLayout(
        sidebarPanel(

            fileInput("counts", "Upload count_matrix.tsv"),
            fileInput("sampleinfo", "Upload sample_info.csv"),

            selectInput("contrast_group",
                        "Choose grouping column:",
                        choices = c("condition", "strain_group"),
                        selected = "condition"),

            uiOutput("level_selector"),

            h4("Select genes to inspect:"),
            uiOutput("gene_select_ui"),

            actionButton("run", "Run DESeq2", class = "btn-primary")
        ),

        mainPanel(
            tabsetPanel(
                tabPanel("PCA Plot", plotOutput("pcaPlot", height="500px")),
                tabPanel("MA Plot", plotOutput("maPlot", height="500px")),
                tabPanel("Volcano Plot", plotOutput("volcanoPlot", height="500px")),
                tabPanel("Selected Gene Stats", dataTableOutput("geneStatsTable")),
                tabPanel("DE Results (All Genes)", dataTableOutput("resultsTable"))
            )
        )
    )
)

server <- function(input, output, session) {

    ### ===================== Data Loading ======================

    counts_data <- reactive({
        req(input$counts)
        read.table(input$counts$datapath, header = TRUE, row.names = 1, sep = "\t")
    })

    sample_info <- reactive({
        req(input$sampleinfo)
        read.csv(input$sampleinfo$datapath, row.names = 1)
    })


    ### ===================== Dynamic Contrast UI ======================

    output$level_selector <- renderUI({
        req(sample_info())
        cond_col <- input$contrast_group
        levs <- unique(sample_info()[[cond_col]])
        selectInput("contrast",
                    "Choose comparison:",
                    choices = combn(levs, 2, FUN=function(x) paste(x[1], x[2], sep=" vs ")))
    })


    ### ===================== DESeq2 run ======================

    dds_result <- eventReactive(input$run, {
        count_matrix <- counts_data()
        sampleinfo <- sample_info()

        stopifnot(all(colnames(count_matrix) == rownames(sampleinfo)))

        cond_col <- input$contrast_group

        dds <- DESeqDataSetFromMatrix(
            countData = count_matrix,
            colData = sampleinfo,
            design = as.formula(paste("~", cond_col))
        )

        dds <- dds[rowSums(counts(dds)) > 10, ]
        dds <- DESeq(dds)

        return(dds)
    })


    ### ===================== Pathway Gene Mapping ======================
    # You fill in these IDs (you already found them)

    pathway_gene_map <- reactive({

        c(
            "ICL1" = "gene:CENPK1137D_3473",
            "MLS1" = "gene:CENPK1137D_2563",
            "UGA1" = "gene:CENPK1137D_2989",
            "UGA2" = "gene:CENPK1137D_4550",
            "GAD1" = "gene:CENPK1137D_289"
        )
    })


    ### ===================== Gene selector UI ======================

    output$gene_select_ui <- renderUI({
        selectizeInput(
            "targetGenes",
            "Highlight genes:",
            choices = names(pathway_gene_map()),
            multiple = TRUE,
            selected = NULL
        )
    })


    ### ===================== DE Results with qvalues ======================

    de_results_df <- reactive({
        req(dds_result())

        cond_col <- input$contrast_group
        groups <- strsplit(input$contrast, " vs ")[[1]]

        res <- results(dds_result(), contrast = c(cond_col, groups[1], groups[2]))
        df <- as.data.frame(res)

        # Add fdrtool q-values
        df$qvalue <- fdrtool(df$pvalue, statistic="pvalue", plot=FALSE)$qval

        return(df)
    })


    ### ===================== PCA ======================

    output$pcaPlot <- renderPlot({
        req(dds_result())

        vsd <- vst(dds_result())
        pca <- prcomp(t(assay(vsd)))

        percentVar <- round(100 * pca$sdev^2 / sum(pca$sdev^2), 1)
        cond <- dds_result()[[input$contrast_group]]

        df <- data.frame(PC1 = pca$x[,1], PC2 = pca$x[,2], cond = cond)

        ggplot(df, aes(PC1, PC2, color = cond)) +
            geom_point(size = 5, alpha = .8) +
            geom_hline(yintercept=0, linetype="dashed", color="grey50") +
            geom_vline(xintercept=0, linetype="dashed", color="grey50") +
            xlab(paste0("PC1 (", percentVar[1], "%)")) +
            ylab(paste0("PC2 (", percentVar[2], "%)")) +
            theme_minimal(base_size = 16)
    })


    ### ===================== MA Plot ======================

    output$maPlot <- renderPlot({

    df <- de_results_df()
    df$log10base <- log10(df$baseMean + 1)

    sel_map <- pathway_gene_map()
    highlight_ids <- sel_map[input$targetGenes]

    ggplot(df, aes(log10base, log2FoldChange)) +
        
        # ---- Normal MA colour ----
        geom_point(aes(color = (qvalue < 0.1)), alpha = 0.5) +
        scale_color_manual(values = c("grey60", "red"), name = "Significant (q<0.1)") +

        # ---- highlight ----
        geom_point(
            data = df[rownames(df) %in% highlight_ids, ],
            color = "gold", size = 3, shape = 8
        ) +

        theme_minimal(base_size = 16) +
        xlab("log10(baseMean)") +
        ggtitle("MA Plot (with Highlighted Pathway Genes)")
})



    ### ===================== Volcano Plot ======================

   output$volcanoPlot <- renderPlot({

    df <- de_results_df()
    df$log10p <- -log10(df$pvalue)

    sel_map <- pathway_gene_map()
    highlight_ids <- sel_map[input$targetGenes]

    ggplot(df, aes(log2FoldChange, log10p)) +

        # ---- Normal significance colour ----
        geom_point(aes(color = (qvalue < 0.1)), alpha = 0.6) +
        scale_color_manual(values=c("black","red"), name="Significant (q<0.1)") +

        # ---- cover：highlight pathway gene ----
        geom_point(
            data = df[rownames(df) %in% highlight_ids, ],
            color = "gold", size = 3, shape = 8
        ) +

        theme_minimal(base_size = 16) +
        xlab("log2 Fold Change") +
        ylab("-log10(p-value)") +
        ggtitle("Volcano Plot (with Highlighted Pathway Genes)") +
        geom_hline(yintercept = -log10(0.05), linetype="dashed", color="blue") +
        geom_vline(xintercept = c(-1,1), linetype="dashed", color="blue")
})



    ### ===================== Selected Gene Table ======================

    output$geneStatsTable <- renderDataTable({

    df <- de_results_df()
    selected <- input$targetGenes
    if (length(selected) == 0) return(NULL)

    ids <- pathway_gene_map()[selected]
    out <- df[rownames(df) %in% ids, ]

    out$gene_name <- names(ids)[match(rownames(out), ids)]

    datatable(
        out[, c("gene_name", "log2FoldChange", "pvalue", "qvalue", "baseMean")],
        filter = "top",
        options = list(pageLength = 15)
    )
})



    ### ===================== All DE Genes Table ======================

    output$resultsTable <- renderDataTable({
        de_results_df()
    })
}

shinyApp(ui, server)
```

